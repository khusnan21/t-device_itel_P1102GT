# init.recovery.mt6789.rc - TWRP-friendly for MT6789

import /init.recovery.project.rc
import /init.tee.rc

# ----------------------------
# Early init properties
# ----------------------------
on init
    setprop sys.usb.configfs 1
    setprop sys.usb.controller "musb-hdrc"
    setprop sys.usb.ffs.aio_compat 0
    export LD_LIBRARY_PATH /system/lib64:/vendor/lib64:/vendor/lib64/hw
    setprop crypto.ready 1
    setprop ro.twrp.boot true

# ----------------------------
# Filesystem early mount
# ----------------------------
on fs
    # Install keyring
    install_keyring

    # Mount essential partitions from fstab early
    mount_all /first_stage_ramdisk/fstab.mt6789 --early

    # Symlink UFS preloader
    symlink /dev/block/mapper/pl_a /dev/block/by-name/preloader_raw_a
    symlink /dev/block/mapper/pl_b /dev/block/by-name/preloader_raw_b
    symlink /dev/block/mapper/pl_a /dev/block/platform/bootdevice/by-name/preloader_raw_a
    symlink /dev/block/mapper/pl_b /dev/block/platform/bootdevice/by-name/preloader_raw_b

    # Bootloader links
    symlink /dev/block/by-name/lk1 /dev/block/by-name/bootloader1
    symlink /dev/block/by-name/lk2 /dev/block/by-name/bootloader2

# ----------------------------
# Early filesystem services
# ----------------------------
on early-fs
    start vold

# ----------------------------
# Post filesystem services
# ----------------------------
on post-fs
    start boot-hal-1-2

# ----------------------------
# UFS symlink service
# ----------------------------
service mtk.plpath.utils.link /system/bin/mtk_plpath_utils
    class main
    user root
    group root system
    oneshot
    disabled
    seclabel u:r:recovery:s0

on boot
    start mtk.plpath.utils.link

# ----------------------------
# KeyMint / TrustKernel service for decryption
# ----------------------------
service vendor.keymint-trustkernel /vendor/bin/hw/android.hardware.security.keymint-service.trustkernel
    class early_hal
    interface android.hardware.keymaster@4.0::IKeymasterDevice
    user root
    group root
    seclabel u:r:recovery:s0
    oneshot
    disabled

on property:crypto.ready=1
    start vendor.keymint-trustkernel

# ----------------------------
# Minimal ueventd
# ----------------------------
on fs
    import /vendor/etc/ueventd.recovery.rc

# ----------------------------
# Post init logging
# ----------------------------
on property:ro.twrp.boot=1
    write /proc/sys/kernel/printk "4 4 1 7"
    write /proc/sys/vm/drop_caches "3"

# ----------------------------
# Optional: USB OTG mount support
# ----------------------------
on post-fs
    mkdir /usb-otg 0770 root shell
    mkdir /usb_otg 0770 root shell
